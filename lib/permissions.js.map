{"version":3,"sources":["../src/permissions.js"],"names":[],"mappings":"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","file":"permissions.js","sourcesContent":["var utils = require(\"./utils\");\r\n\r\n/**\r\n * Allows you to to check on the security of a list or site. You shouldn't be creating instances of the this class, you will get it from the Web or List class.\r\n * @class\r\n * @param {string} baseUrl - Url to the securable\r\n * @param {IBaseDao} dao - Data access object used to make requests.\r\n * @example <caption>Access Permissions class using the 'permissions' property on a Web</caption>\r\n * var dao = new SPScript.RestDao(_spPageContextInfo.webAbsoluteUrl);\r\n *\r\n * dao.web.permissions.getRoleAssignments()\r\n *     .then(function(roleAssignments) { console.log(roleAssignments) });\r\n * @example <caption>Access Permissions class using the 'permissions' property on a List</caption>\r\n * dao.lists(\"Restricted Library\").permissions.getRoleAssignments()\r\n *     .then(function(roleAssignments) { console.log(roleAssignments) });\r\n */\r\nvar Permissions = function(baseUrl, dao) {\r\n   this._dao = dao;\r\n   this.baseUrl = baseUrl\r\n};\r\n\r\n/**\r\n * Gets all the role assignments on that securable\r\n * @returns {Promise<Array<RoleAssignment>>} - A Promise that resolves to an array of role assignments\r\n * @example\r\n * dao.web.permissions.getRoleAssignments()\r\n *     .then(function(roleAssignments) { console.log(roleAssignments) });\r\n */\r\nPermissions.prototype.getRoleAssignments = function() {\r\n   var url = this.baseUrl + \"/RoleAssignments?$expand=Member,RoleDefinitionBindings\";\r\n   return this._dao.get(url)\r\n      .then(utils.validateODataV2)\r\n      .then(results => results.map(transforms.roleAssignment));\r\n};\r\n\r\n/**\r\n * Gets all the role assignments on that securable. If you don't pass an email, it will use the current user.\r\n * @param {string} [email] - If you don't pass an email it will use current user\r\n * @returns {Promise<Array>} - A Promise that resolves to an array of string base permission values\r\n * @example <caption>Get the current users permissions on a site</caption>\r\n * dao.web.permissions.check()\r\n *     .then(function(basePermissions) { console.log(basePermissions) });\r\n * @example <caption>Get a specified user's permissions on a list</caption>\r\n * var email = \"andrew@andrewpetersen.onmicrosoft.com\"\r\n * dao.lists(\"Restricted Library\").permissions.check(email)\r\n *     .then(function(basePermissions) { console.log(basePermissions) });\r\n */\r\nPermissions.prototype.check = function(email) {\r\n\r\n   var checkPrivs = (user) => {\r\n      var login = encodeURIComponent(user.LoginName);\r\n      var url = this.baseUrl + \"/getusereffectivepermissions(@v)?@v='\" + login + \"'\";\r\n      return this._dao.get(url).then(utils.validateODataV2);\r\n   };\r\n\r\n   // If no email is passed, then get current user, else get user by email\r\n   var req = !email \r\n      ? this._dao.get('/web/getuserbyid(' + _spPageContextInfo.userId + ')').then(data => data.d)\r\n      : this._dao.web.getUser(email)\r\n\r\n   return req.then(checkPrivs)\r\n      .then(privs => permissionMaskToStrings(privs.GetUserEffectivePermissions.Low, privs.GetUserEffectivePermissions.High));\r\n}\r\n\r\n/**\r\n * Represents a permission on the securable\r\n * @typedef {Object} RoleMember\r\n * @property {string} login - Login Name\r\n * @property {string} name - User or Group title\r\n * @property {string} id - Member Id\r\n */\r\n\r\n/**\r\n * Represents a permission on the securable\r\n * @typedef {Object} RoleDef\r\n * @property {string} name - Role Definition name\r\n * @property {string} description - Role Definition description\r\n * @property {Array} basePermissions - Array of base permission strings\r\n */\r\n\r\n/**\r\n * Represents a permission on the securable\r\n * @typedef {Object} RoleAssignment\r\n * @property {RoleMember} member - User or group\r\n * @property {Array<RoleDef>} roles - An array of role definitions\r\n */\r\nvar transforms = {\r\n   roleAssignment: function(raw) {\r\n      var priv = {\r\n         member: {\r\n            login: raw.Member.LoginName,\r\n            name: raw.Member.Title,\r\n            id: raw.Member.Id\r\n         }\r\n      };\r\n      priv.roles = raw.RoleDefinitionBindings.results.map(function(roleDef) {\r\n         return {\r\n            name: roleDef.Name,\r\n            description: roleDef.Description,\r\n            basePermissions: permissionMaskToStrings(roleDef.BasePermissions.Low, roleDef.BasePermissions.High)\r\n         }; \r\n      });\r\n      return priv;\r\n   }\r\n};\r\n\r\nvar permissionMaskToStrings = function(lowMask, highMask) {\r\n   var basePermissions = [];\r\n   spBasePermissions.forEach(function(basePermission) {\r\n      if ((basePermission.low & lowMask) > 0 || (basePermission.high & highMask) > 0) {\r\n         basePermissions.push(basePermission.name);\r\n      }\r\n   });\r\n   return basePermissions;\r\n};\r\n\r\n// Scraped it from SP.PermissionKind. \r\n// Storing it in here to remove sp.js dependency\r\n\r\n// var basePermissions = [];\r\n// Object.keys(SP.PermissionKind).forEach(function(key) { \r\n// \tvar perm = new SP.BasePermissions();\r\n//     perm.set(SP.PermissionKind[key]);\r\n//     var permisison = {\r\n//     \tname: key,\r\n//     \tlow: perm.$A_1,\r\n//     \thigh: perm.$9_1\r\n//     };\r\n//     basePermissions.push(permisison);\r\n// });\r\n\r\nvar spBasePermissions = [{\r\n   \"name\": \"emptyMask\",\r\n   \"low\": 0,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"viewListItems\",\r\n   \"low\": 1,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"addListItems\",\r\n   \"low\": 2,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"editListItems\",\r\n   \"low\": 4,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"deleteListItems\",\r\n   \"low\": 8,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"approveItems\",\r\n   \"low\": 16,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"openItems\",\r\n   \"low\": 32,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"viewVersions\",\r\n   \"low\": 64,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"deleteVersions\",\r\n   \"low\": 128,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"cancelCheckout\",\r\n   \"low\": 256,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"managePersonalViews\",\r\n   \"low\": 512,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"manageLists\",\r\n   \"low\": 2048,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"viewFormPages\",\r\n   \"low\": 4096,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"anonymousSearchAccessList\",\r\n   \"low\": 8192,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"open\",\r\n   \"low\": 65536,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"viewPages\",\r\n   \"low\": 131072,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"addAndCustomizePages\",\r\n   \"low\": 262144,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"applyThemeAndBorder\",\r\n   \"low\": 524288,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"applyStyleSheets\",\r\n   \"low\": 1048576,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"viewUsageData\",\r\n   \"low\": 2097152,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"createSSCSite\",\r\n   \"low\": 4194304,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"manageSubwebs\",\r\n   \"low\": 8388608,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"createGroups\",\r\n   \"low\": 16777216,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"managePermissions\",\r\n   \"low\": 33554432,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"browseDirectories\",\r\n   \"low\": 67108864,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"browseUserInfo\",\r\n   \"low\": 134217728,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"addDelPrivateWebParts\",\r\n   \"low\": 268435456,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"updatePersonalWebParts\",\r\n   \"low\": 536870912,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"manageWeb\",\r\n   \"low\": 1073741824,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"anonymousSearchAccessWebLists\",\r\n   \"low\": -2147483648,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"useClientIntegration\",\r\n   \"low\": 0,\r\n   \"high\": 16\r\n}, {\r\n   \"name\": \"useRemoteAPIs\",\r\n   \"low\": 0,\r\n   \"high\": 32\r\n}, {\r\n   \"name\": \"manageAlerts\",\r\n   \"low\": 0,\r\n   \"high\": 64\r\n}, {\r\n   \"name\": \"createAlerts\",\r\n   \"low\": 0,\r\n   \"high\": 128\r\n}, {\r\n   \"name\": \"editMyUserInfo\",\r\n   \"low\": 0,\r\n   \"high\": 256\r\n}, {\r\n   \"name\": \"enumeratePermissions\",\r\n   \"low\": 0,\r\n   \"high\": 1073741824\r\n}];\r\n\r\nmodule.exports = Permissions; "]}