{"version":3,"sources":["../src/permissions.js"],"names":["utils","require","Permissions","baseUrl","dao","_dao","prototype","getRoleAssignments","url","get","then","validateODataV2","results","map","transforms","roleAssignment","check","email","checkPrivs","user","login","encodeURIComponent","LoginName","isBrowser","Promise","reject","req","_spPageContextInfo","userId","data","d","web","getUser","permissionMaskToStrings","privs","GetUserEffectivePermissions","Low","High","raw","priv","member","Member","name","Title","id","Id","roles","RoleDefinitionBindings","roleDef","Name","description","Description","basePermissions","BasePermissions","lowMask","highMask","spBasePermissions","forEach","basePermission","low","high","push","module","exports"],"mappings":"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","file":"permissions.js","sourcesContent":["var utils = require(\"./utils\");\r\n\r\n/**\r\n * Allows you to to check on the security of a list or site. You shouldn't be creating instances of the this class, you will get it from the Web or List class.\r\n * @class\r\n * @param {string} baseUrl - Url to the securable\r\n * @param {IBaseDao} dao - Data access object used to make requests.\r\n * @example <caption>Access Permissions class using the 'permissions' property on a Web</caption>\r\n * var dao = new SPScript.RestDao(_spPageContextInfo.webAbsoluteUrl);\r\n *\r\n * dao.web.permissions.getRoleAssignments()\r\n *     .then(function(roleAssignments) { console.log(roleAssignments) });\r\n * @example <caption>Access Permissions class using the 'permissions' property on a List</caption>\r\n * dao.lists(\"Restricted Library\").permissions.getRoleAssignments()\r\n *     .then(function(roleAssignments) { console.log(roleAssignments) });\r\n */\r\nvar Permissions = function(baseUrl, dao) {\r\n   this._dao = dao;\r\n   this.baseUrl = baseUrl\r\n};\r\n\r\n/**\r\n * Gets all the role assignments on that securable\r\n * @returns {Promise<Array<RoleAssignment>>} - A Promise that resolves to an array of role assignments\r\n * @example\r\n * dao.web.permissions.getRoleAssignments()\r\n *     .then(function(roleAssignments) { console.log(roleAssignments) });\r\n */\r\nPermissions.prototype.getRoleAssignments = function() {\r\n   var url = this.baseUrl + \"/RoleAssignments?$expand=Member,RoleDefinitionBindings\";\r\n   return this._dao.get(url)\r\n      .then(utils.validateODataV2)\r\n      .then(results => results.map(transforms.roleAssignment));\r\n};\r\n\r\n/**\r\n * Gets all the role assignments on that securable. If you don't pass an email, it will use the current user.\r\n * @param {string} [email] - If you don't pass an email it will use current user\r\n * @returns {Promise<Array>} - A Promise that resolves to an array of string base permission values\r\n * @example <caption>Get the current users permissions on a site</caption>\r\n * dao.web.permissions.check()\r\n *     .then(function(basePermissions) { console.log(basePermissions) });\r\n * @example <caption>Get a specified user's permissions on a list</caption>\r\n * var email = \"andrew@andrewpetersen.onmicrosoft.com\"\r\n * dao.lists(\"Restricted Library\").permissions.check(email)\r\n *     .then(function(basePermissions) { console.log(basePermissions) });\r\n */\r\nPermissions.prototype.check = function(email) {\r\n\r\n   var checkPrivs = (user) => {\r\n      var login = encodeURIComponent(user.LoginName);\r\n      var url = this.baseUrl + \"/getusereffectivepermissions(@v)?@v='\" + login + \"'\";\r\n      return this._dao.get(url).then(utils.validateODataV2);\r\n   };\r\n\r\n   //if no email, and no current user id, reject\r\n   if (!email && !utils.isBrowser()) {\r\n      return Promise.reject(\"Can't Check Permissions.  No email passed and no current user\")\r\n   }\r\n   \r\n   // If no email is passed, then get current user, else get user by email\r\n   var req = !email \r\n      ? this._dao.get('/web/getuserbyid(' + _spPageContextInfo.userId + ')').then(data => data.d)\r\n      : this._dao.web.getUser(email)\r\n\r\n   return req.then(checkPrivs)\r\n      .then(privs => permissionMaskToStrings(privs.GetUserEffectivePermissions.Low, privs.GetUserEffectivePermissions.High));\r\n}\r\n\r\n/**\r\n * Represents a permission on the securable\r\n * @typedef {Object} RoleMember\r\n * @property {string} login - Login Name\r\n * @property {string} name - User or Group title\r\n * @property {string} id - Member Id\r\n */\r\n\r\n/**\r\n * Represents a permission on the securable\r\n * @typedef {Object} RoleDef\r\n * @property {string} name - Role Definition name\r\n * @property {string} description - Role Definition description\r\n * @property {Array} basePermissions - Array of base permission strings\r\n */\r\n\r\n/**\r\n * Represents a permission on the securable\r\n * @typedef {Object} RoleAssignment\r\n * @property {RoleMember} member - User or group\r\n * @property {Array<RoleDef>} roles - An array of role definitions\r\n */\r\nvar transforms = {\r\n   roleAssignment: function(raw) {\r\n      var priv = {\r\n         member: {\r\n            login: raw.Member.LoginName,\r\n            name: raw.Member.Title,\r\n            id: raw.Member.Id\r\n         }\r\n      };\r\n      priv.roles = raw.RoleDefinitionBindings.results.map(function(roleDef) {\r\n         return {\r\n            name: roleDef.Name,\r\n            description: roleDef.Description,\r\n            basePermissions: permissionMaskToStrings(roleDef.BasePermissions.Low, roleDef.BasePermissions.High)\r\n         }; \r\n      });\r\n      return priv;\r\n   }\r\n};\r\n\r\nvar permissionMaskToStrings = function(lowMask, highMask) {\r\n   var basePermissions = [];\r\n   spBasePermissions.forEach(function(basePermission) {\r\n      if ((basePermission.low & lowMask) > 0 || (basePermission.high & highMask) > 0) {\r\n         basePermissions.push(basePermission.name);\r\n      }\r\n   });\r\n   return basePermissions;\r\n};\r\n\r\n// Scraped it from SP.PermissionKind. \r\n// Storing it in here to remove sp.js dependency\r\n\r\n// var basePermissions = [];\r\n// Object.keys(SP.PermissionKind).forEach(function(key) { \r\n// \tvar perm = new SP.BasePermissions();\r\n//     perm.set(SP.PermissionKind[key]);\r\n//     var permisison = {\r\n//     \tname: key,\r\n//     \tlow: perm.$A_1,\r\n//     \thigh: perm.$9_1\r\n//     };\r\n//     basePermissions.push(permisison);\r\n// });\r\n\r\nvar spBasePermissions = [{\r\n   \"name\": \"emptyMask\",\r\n   \"low\": 0,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"viewListItems\",\r\n   \"low\": 1,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"addListItems\",\r\n   \"low\": 2,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"editListItems\",\r\n   \"low\": 4,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"deleteListItems\",\r\n   \"low\": 8,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"approveItems\",\r\n   \"low\": 16,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"openItems\",\r\n   \"low\": 32,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"viewVersions\",\r\n   \"low\": 64,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"deleteVersions\",\r\n   \"low\": 128,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"cancelCheckout\",\r\n   \"low\": 256,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"managePersonalViews\",\r\n   \"low\": 512,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"manageLists\",\r\n   \"low\": 2048,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"viewFormPages\",\r\n   \"low\": 4096,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"anonymousSearchAccessList\",\r\n   \"low\": 8192,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"open\",\r\n   \"low\": 65536,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"viewPages\",\r\n   \"low\": 131072,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"addAndCustomizePages\",\r\n   \"low\": 262144,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"applyThemeAndBorder\",\r\n   \"low\": 524288,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"applyStyleSheets\",\r\n   \"low\": 1048576,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"viewUsageData\",\r\n   \"low\": 2097152,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"createSSCSite\",\r\n   \"low\": 4194304,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"manageSubwebs\",\r\n   \"low\": 8388608,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"createGroups\",\r\n   \"low\": 16777216,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"managePermissions\",\r\n   \"low\": 33554432,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"browseDirectories\",\r\n   \"low\": 67108864,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"browseUserInfo\",\r\n   \"low\": 134217728,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"addDelPrivateWebParts\",\r\n   \"low\": 268435456,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"updatePersonalWebParts\",\r\n   \"low\": 536870912,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"manageWeb\",\r\n   \"low\": 1073741824,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"anonymousSearchAccessWebLists\",\r\n   \"low\": -2147483648,\r\n   \"high\": 0\r\n}, {\r\n   \"name\": \"useClientIntegration\",\r\n   \"low\": 0,\r\n   \"high\": 16\r\n}, {\r\n   \"name\": \"useRemoteAPIs\",\r\n   \"low\": 0,\r\n   \"high\": 32\r\n}, {\r\n   \"name\": \"manageAlerts\",\r\n   \"low\": 0,\r\n   \"high\": 64\r\n}, {\r\n   \"name\": \"createAlerts\",\r\n   \"low\": 0,\r\n   \"high\": 128\r\n}, {\r\n   \"name\": \"editMyUserInfo\",\r\n   \"low\": 0,\r\n   \"high\": 256\r\n}, {\r\n   \"name\": \"enumeratePermissions\",\r\n   \"low\": 0,\r\n   \"high\": 1073741824\r\n}];\r\n\r\nmodule.exports = Permissions; "]}