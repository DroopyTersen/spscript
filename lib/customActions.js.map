{"version":3,"sources":["../src/customActions.js"],"names":["utils","require","headers","metadata","__metadata","CustomActions","dao","_dao","scopes","id","name","url","getById","Site","Web","prototype","get","then","validateODataV2","siteCustomActions","concat","webCustomActions","matches","customActions","filter","a","Name","length","Error","_getUrl","Scope","Id","_getUrlAndDigest","prep","getRequestDigest","digest","update","updates","opts","getUpdateHeaders","post","remove","getDeleteHeaders","add","customAction","Location","scope","getAddHeaders","addScriptLink","Title","Description","Group","Sequence","ScriptSrc","addCSSLink","scriptBlockStr","ScriptBlock","module","exports"],"mappings":"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","file":"customActions.js","sourcesContent":["var utils = require(\"./utils\");\r\nvar headers = require(\"./requestHeaders\");\r\n\r\nvar metadata = {\r\n\t__metadata: {\r\n\t\t\"type\": \"SP.UserCustomAction\"\r\n\t}\r\n};\r\n\r\nvar CustomActions = function (dao) {\r\n\tthis._dao = dao;\r\n\r\n\tthis.scopes = {\r\n\t\t\"Web\": {\r\n\t\t\tid: 3,\r\n\t\t\tname: \"Web\",\r\n\t\t\turl: \"/web/usercustomactions\"\r\n\t\t},\r\n\t\t\"Site\": {\r\n\t\t\tid: 2,\r\n\t\t\tname: \"Site\",\r\n\t\t\turl: \"/site/usercustomactions\"\r\n\t\t}\r\n\t};\r\n\tthis.scopes.getById = (id) => id === 2 ? this.scopes.Site : this.scopes.Web\r\n};\r\n\r\n// \r\n// If a name is passed, filter the result set\r\nCustomActions.prototype.get = function (name) {\r\n\r\n\t// first get the site scoped ones, then the web scoped ones\r\n\treturn this._dao.get(this.scopes.Site.url)\r\n\t\t.then(utils.validateODataV2)\r\n\t\t.then(siteCustomActions => {\r\n\t\t\treturn this._dao.get(this.scopes.Web.url)\r\n\t\t\t\t.then(utils.validateODataV2)\r\n\t\t\t\t//combine site scoped and web scoped into single array\r\n\t\t\t\t.then(webCustomActions => siteCustomActions.concat(webCustomActions));\r\n\t\t})\r\n\t\t.then(customActions => {\r\n\t\t\t// if a name was passed filter it otherwise return everything\r\n\t\t\tif (name) {\r\n\t\t\t\tvar matches = customActions.filter(a => a.Name === name);\r\n\t\t\t\tif (matches.length) {\r\n\t\t\t\t\treturn matches[0]\r\n\t\t\t\t}\r\n\t\t\t\tthrow new Error(\"Unable to find Custom Action with name: \" + name );\r\n\t\t\t}\r\n\t\t\telse return customActions;\r\n\t\t});\r\n};\r\n\r\n\r\nCustomActions.prototype._getUrl = function (name) {\r\n\treturn this.get(name)\r\n\t\t.then(a => `${this.scopes.getById(a.Scope).url}('${a.Id}')`);\r\n};\r\n\r\nCustomActions.prototype._getUrlAndDigest = function (name) {\r\n\tvar prep = {};\r\n\treturn this._getUrl(name)\r\n\t\t.then(url => {\r\n\t\t\tprep.url = url;\r\n\t\t\treturn this._dao.getRequestDigest()\r\n\t\t})\r\n\t\t.then(digest => {\r\n\t\t\tprep.digest = digest;\r\n\t\t\treturn prep;\r\n\t\t});\r\n};\r\n\r\nCustomActions.prototype.update = function (updates) {\r\n\tif (!updates || !updates.Name) throw new Error(\"You must at least pass a Custom Action 'Name'\");\r\n\r\n\treturn this._getUrlAndDigest(updates.Name)\r\n\t\t.then(prep => {\r\n\t\t\tupdates = Object.assign({}, metadata, updates);\r\n\t\t\tvar opts = {\r\n\t\t\t\theaders: headers.getUpdateHeaders(prep.digest)\r\n\t\t\t};\r\n\t\t\treturn this._dao.post(prep.url, updates, opts);\r\n\t\t})\r\n};\r\n\r\n\r\nCustomActions.prototype.remove = function (name) {\r\n\tif (!name) throw new Error(\"You must at least pass a Custom Action 'Name'\");\r\n\treturn this._getUrlAndDigest(name)\r\n\t\t.then(prep => {\r\n\t\t\tvar opts = {\r\n\t\t\t\theaders: headers.getDeleteHeaders(prep.digest)\r\n\t\t\t};\r\n\t\t\treturn this._dao.post(prep.url, {}, opts);\r\n\t\t});\r\n};\r\n\r\nCustomActions.prototype.add = function (customAction) {\r\n\tif (!customAction || !customAction.Name || !customAction.Location)\r\n\t\tthrow new Error(\"You must at least pass a Custom Action 'Name' and 'Location'\");\r\n\tcustomAction.Scope = customAction.Scope || \"Web\";\r\n\treturn this._dao.getRequestDigest()\r\n\t\t.then(digest => {\r\n\t\t\tcustomAction = Object.assign({}, metadata, customAction);\r\n\t\t\tvar scope = this.scopes[customAction.Scope]\r\n\t\t\tcustomAction.Scope = scope.id;\r\n\t\t\tvar opts = {\r\n\t\t\t\theaders: headers.getAddHeaders(digest)\r\n\t\t\t};\r\n\t\t\treturn this._dao.post(scope.url, customAction, opts);\r\n\t\t})\r\n};\r\n\r\n\r\nCustomActions.prototype.addScriptLink = function (name, url, opts) {\r\n\tvar customAction = {\r\n\t\tName: name,\r\n\t\tTitle: name,\r\n\t\tDescription: name,\r\n\t\tGroup: name,\r\n\t\tSequence: 100,\r\n\t\tScope: \"Web\",\r\n\t\tLocation: \"ScriptLink\",\r\n\t\tScriptSrc: url\r\n\t};\r\n\tcustomAction = Object.assign({}, customAction, opts || {});\r\n\r\n\treturn this.add(customAction);\r\n};\r\n\r\nCustomActions.prototype.addCSSLink = function (name, url, opts) {\r\n    var scriptBlockStr = `\r\n\t\t(function() {\r\n\t\t\tvar head = document.querySelector(\"head\");\r\n\t\t\tvar styleTag = document.createElement(\"style\");\r\n\t\t\tstyleTag.appendChild(document.createTextNode(\"body { opacity: 0 }\"));\r\n\t\t\t\r\n\t\t\tvar linkTag = document.createElement(\"link\");\r\n\t\t\tlinkTag.rel = \"stylesheet\";\tlinkTag.href = \"${url}\"; linkTag.type = \"text/css\";\r\n\t\t\tlinkTag.addEventListener(\"load\", function() {\r\n\t\t\t\thead.removeChild(styleTag);\r\n\t\t\t});\r\n\r\n\t\t\thead.appendChild(styleTag);\r\n\t\t\thead.appendChild(linkTag);\r\n\t\t})();`\r\n\r\n\tvar customAction = {\r\n\t\tName: name,\r\n\t\tTitle: name,\r\n\t\tDescription: name,\r\n\t\tGroup: name,\r\n\t\tSequence: 100,\r\n\t\tScope: \"Web\",\r\n\t\tLocation: \"ScriptLink\",\r\n\t\tScriptBlock: scriptBlockStr\r\n\t};\r\n\tcustomAction = Object.assign({}, customAction, opts || {});\r\n\t\r\n\treturn this.add(customAction);\r\n};\r\nCustomActions.metadata = metadata;\r\n\r\nmodule.exports = CustomActions;"]}